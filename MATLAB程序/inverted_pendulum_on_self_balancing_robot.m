clc
clear
close all
% 参数
m_1 = 0.9;
m_2 = 0.1;
r = 0.0335;
L_1 = 0.126;
L_2 = 0.390;
l_1 = L_1/2;
l_2 = L_2/2;
g = 9.8;
I_1 = (1/12)*m_1*L_1^2;
I_2 = (1/12)*m_2*L_2^2;
% p矩阵
p_11 = 1;
p_12 = 0;
p_13 = 0;
p_14 = 0;
p_21 = 0;
p_22 = 1;
p_23 = 0;
p_24 = 0;
p_31 = (r/2)*(m_1*l_1 + m_2*L_1);
p_32 = (r/2)*(m_1*l_1 + m_2*L_1);
p_33 = m_1*l_1^2 + m_2*L_1^2 + I_1;
p_34 = m_2*L_1*l_2;
p_41 = (r/2)*m_2*l_2;
p_42 = (r/2)*m_2*l_2;
p_43 = m_2*L_1*l_2;
p_44 = m_2*l_2^2 + I_2;
p = [p_11 p_12 p_13 p_14;
     p_21 p_22 p_23 p_24;
     p_31 p_32 p_33 p_34;
     p_41 p_42 p_43 p_44];
% q矩阵
q_11  = 0;
q_12  = 0;
q_13  = 0;
q_14  = 0;
q_15  = 0;
q_16  = 0;
q_17  = 0;
q_18  = 0;
q_19  = 1;
q_110 = 0;
q_21  = 0;
q_22  = 0;
q_23  = 0;
q_24  = 0;
q_25  = 0;
q_26  = 0;
q_27  = 0;
q_28  = 0;
q_29  = 0;
q_210 = 1;
q_31  = 0;
q_32  = 0;
q_33  = (m_1*l_1 + m_2*L_1)*g;
q_34  = 0;
q_35  = 0;
q_36  = 0;
q_37  = 0;
q_38  = 0;
q_39  = 0;
q_310 = 0;
q_41  = 0;
q_42  = 0;
q_43  = 0;
q_44  = m_2*g*l_2;
q_45  = 0;
q_46  = 0;
q_47  = 0;
q_48  = 0;
q_49  = 0;
q_410 = 0;
q = [q_11 q_12 q_13 q_14 q_15 q_16 q_17 q_18 q_19 q_110;
     q_21 q_22 q_23 q_24 q_25 q_26 q_27 q_28 q_29 q_210;
     q_31 q_32 q_33 q_34 q_35 q_36 q_37 q_38 q_39 q_310;
     q_41 q_42 q_43 q_44 q_45 q_46 q_47 q_48 q_49 q_410];
% 计算结果
temp = p^-1*q;
% A矩阵
A = [0 0 0 0 1 0 0 0; 0 0 0 0 0 1 0 0; 0 0 0 0 0 0 1 0; 0 0 0 0 0 0 0 1; temp(:,1:8)];
% B矩阵
B = [0 0; 0 0; 0 0; 0 0; temp(:,9:10)];
% C矩阵
C = [1 0 0 0 0 0 0 0;
     0 1 0 0 0 0 0 0;
     0 0 1 0 0 0 0 0;
     0 0 0 1 0 0 0 0];
% D矩阵
D = zeros(4,2);
% LQR控制器
Ts = 0.01;
t = 0:Ts:7;
u = [zeros(size(t)); zeros(size(t))];
[G,H] = c2d(A,B,Ts);
x0 = [0; 0; -0.1745; 0.1745; 0; 0; 0; 0];
Tc = ctrb(G,H);
if (rank(Tc)==8)
    fprintf('此系统是可控的！\n');
    Q = [51.2938 0 0 0 0 0 0 0; 0 51.2938 0 0 0 0 0 0; 0 0 32.8281 0 0 0 0 0; 0 0 0 131.3123 0 0 0 0;...
        0 0 0 0 51.2938 0 0 0; 0 0 0 0 0 51.2938 0 0; 0 0 0 0 0 0 131.3123 0; 0 0 0 0 0 0 0 131.3123];
    rho = 0.0005;
    R = rho*[1 0; 0 1];
    K = dlqr(G,H,Q,R);
    G2 = G-H*K;
    H = zeros(8,2);
    y = dlsim(G2,H,C,D,u,x0);
    subplot(4,1,1)
    plot(t,y(:,1),'b','LineWidth',1.5);
    grid on
    xlabel('Time(s)');
    subplot(4,1,2)
    plot(t,y(:,2),'b','LineWidth',1.5);
    grid on
    xlabel('Time(s)');
    subplot(4,1,3)
    plot(t,y(:,3),'b','LineWidth',1.5);
    grid on
    xlabel('Time(s)');
    subplot(4,1,4)
    plot(t,y(:,4),'b','LineWidth',1.5);
    grid on
    xlabel('Time(s)');
end
fprintf('K_1 = \n');
fprintf('%.4f\n',K(1,:));
fprintf('\n');
fprintf('K_2 = \n');
fprintf('%.4f\n',K(2,:));
